<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workplace Safety Detection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .btn {
            @apply flex items-center justify-center w-full px-6 py-3 text-white font-semibold rounded-lg shadow-md transition-all duration-300 transform hover:scale-105;
        }
        .btn-sm {
            @apply px-4 py-2 text-sm;
        }
        .btn-primary {
            @apply bg-indigo-600 hover:bg-indigo-700;
        }
        .btn-secondary {
            @apply bg-gray-600 hover:bg-gray-700;
        }
        .btn-danger {
            @apply bg-red-600 hover:bg-red-700;
        }
        .icon {
            @apply w-6 h-6 mr-3;
        }
        .icon-sm {
            @apply w-5 h-5 mr-2;
        }
        /* Simple CSS loader */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #4f46e5; /* Indigo */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-2xl w-full text-center">
        
        <!-- Header Section -->
        <div id="header" class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Workplace Safety Detection</h1>
            <p class="text-gray-500">AI-powered monitoring for helmets and vests.</p>
        </div>

        <!-- Initial Start Button -->
        <div id="start-container">
            <button id="start-btn" class="btn btn-primary text-lg">
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.972l-11.54 6.347a1.125 1.125 0 01-1.667-.986V5.653z" /></svg>
                Start Monitoring
            </button>
        </div>

        <!-- Source Selection (hidden by default) -->
        <div id="source-selection" class="hidden space-y-4">
            <button id="webcam-btn" class="btn btn-primary">
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.776 48.776 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" /></svg>
                Use Webcam
            </button>
            <input type="file" id="video-upload-input" class="hidden" accept="video/*">
            <button id="upload-btn" class="btn btn-secondary">
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                Upload a Video
            </button>
        </div>

        <!-- Loading Spinner (hidden by default) -->
        <div id="loading-container" class="hidden">
            <div class="loader"></div>
            <p class="text-gray-600">Processing video...</p>
        </div>

        <!-- Video Display Area (hidden by default) -->
        <div id="video-container" class="hidden mt-6">
            <div id="image-wrapper" class="relative w-full bg-black rounded-lg">
                <img id="video-feed" class="rounded-lg shadow-inner border-2 border-gray-200 w-full" alt="Video Feed">
                <canvas id="pause-canvas" class="hidden absolute top-0 left-0 rounded-lg w-full h-full"></canvas>
            </div>
            <!-- Controls -->
            <div id="controls-container" class="mt-4 flex justify-center space-x-4">
                <button id="back-btn" class="btn btn-sm btn-danger">
                    <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" /></svg>
                    Back
                </button>
                <div id="video-controls" class="hidden flex space-x-4">
                    <button id="play-pause-btn" class="btn btn-sm btn-primary">
                        <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" /></svg>
                        Pause
                    </button>
                    <button id="new-upload-btn" class="btn btn-sm btn-secondary">
                        <svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                        New Video
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Element References ---
        const startContainer = document.getElementById('start-container');
        const sourceSelection = document.getElementById('source-selection');
        const loadingContainer = document.getElementById('loading-container');
        const videoContainer = document.getElementById('video-container');
        const imageWrapper = document.getElementById('image-wrapper');
        const videoFeed = document.getElementById('video-feed');
        const pauseCanvas = document.getElementById('pause-canvas');
        const videoControls = document.getElementById('video-controls');
        
        const startBtn = document.getElementById('start-btn');
        const webcamBtn = document.getElementById('webcam-btn');
        const uploadBtn = document.getElementById('upload-btn');
        const videoUploadInput = document.getElementById('video-upload-input');
        const backBtn = document.getElementById('back-btn');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const newUploadBtn = document.getElementById('new-upload-btn');

        // --- State Management ---
        let currentVideoSrc = '';
        let isPaused = false;

        // --- UI Control Functions ---
        function showScreen(screen) {
            startContainer.classList.add('hidden');
            sourceSelection.classList.add('hidden');
            loadingContainer.classList.add('hidden');
            videoContainer.classList.add('hidden');
            screen.classList.remove('hidden');
        }

        function resetToHome() {
            videoFeed.src = ''; // Stop any active stream
            pauseCanvas.classList.add('hidden');
            videoControls.classList.add('hidden');
            imageWrapper.style.height = ''; // Reset fixed height
            showScreen(sourceSelection);
        }

        // --- Event Listeners ---
        startBtn.addEventListener('click', () => showScreen(sourceSelection));
        
        backBtn.addEventListener('click', resetToHome);

        webcamBtn.addEventListener('click', () => {
            showScreen(loadingContainer);
            videoFeed.classList.remove('hidden');
            videoFeed.src = '/video_feed/webcam';
            videoFeed.onload = () => showScreen(videoContainer);
        });

        uploadBtn.addEventListener('click', () => videoUploadInput.click());
        newUploadBtn.addEventListener('click', () => videoUploadInput.click());

        videoUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                showScreen(loadingContainer);
                const formData = new FormData();
                formData.append('video_file', file);

                fetch('/upload_video', { method: 'POST', body: formData })
                .then(response => {
                    if (!response.ok) throw new Error('Upload failed.');
                    return response.json();
                })
                .then(data => {
                    currentVideoSrc = `/video_feed/upload?session_id=${data.session_id}`;
                    videoFeed.classList.remove('hidden');
                    videoFeed.src = currentVideoSrc;
                    isPaused = false;
                    playPauseBtn.innerHTML = '<svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" /></svg>Pause';
                    videoControls.classList.remove('hidden');
                    videoFeed.onload = () => showScreen(videoContainer);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('There was an error uploading your video.');
                    showScreen(sourceSelection);
                });
            }
        });

        playPauseBtn.addEventListener('click', () => {
            if (isPaused) {
                // --- Resume Logic ---
                pauseCanvas.classList.add('hidden');
                imageWrapper.style.height = ''; // Remove fixed height
                videoFeed.classList.remove('hidden');
                videoFeed.src = currentVideoSrc; // Restart the stream
                playPauseBtn.innerHTML = '<svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5" /></svg>Pause';
                isPaused = false;
            } else {
                // --- Pause Logic ---
                // Set fixed height on wrapper to prevent layout collapse
                imageWrapper.style.height = `${videoFeed.clientHeight}px`;

                const ctx = pauseCanvas.getContext('2d');
                pauseCanvas.width = videoFeed.clientWidth;
                pauseCanvas.height = videoFeed.clientHeight;
                ctx.drawImage(videoFeed, 0, 0, pauseCanvas.width, pauseCanvas.height);
                
                videoFeed.classList.add('hidden'); // Hide the img tag
                pauseCanvas.classList.remove('hidden'); // Show the canvas with the frozen frame
                videoFeed.src = ''; // Stop the stream
                
                playPauseBtn.innerHTML = '<svg class="icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.972l-11.54 6.347a1.125 1.125 0 01-1.667-.986V5.653z" /></svg>Resume';
                isPaused = true;
            }
        });

    </script>
</body>
</html>
